@using SpotMarket.WebAssembly.Models.Presentation

@if (Data?.Items != null && Data.Items.Any())
{
    <div class="analysis-card-list">
        @foreach (var item in Data.Items)
        {
            <div class="analysis-pass-card">
                @* بخش هدر اصلی *@
                <div class="card-header">
                    <div class="header-info">
                        <div class="commodity-name">@item.CommodityName</div>
                        <div class="supplier-info">تحلیل عملکرد کالا</div>
                    </div>
                    <div class="header-icon">
                        <i class="bi bi-bar-chart-line-fill"></i>
                    </div>
                </div>

                @* بخش میانی کارت با متریک‌های اصلی *@
                <div class="card-body">
                    <div class="metric-item">
                        <span class="value">@item.OfferFrequency</span>
                        <span class="label">تناوب عرضه</span>
                    </div>
                    <div class="metric-item">
                        <span class="value">@item.AverageOfferVolume</span>
                        <span class="label">حجم متوسط عرضه</span>
                    </div>
                </div>

                @* بخش فوتر برای باز و بسته کردن جزئیات *@
                <div class="card-footer">
                    <div class="details-toggle" @onclick="() => ToggleDetails(item.CommodityId)">
                        <span>@(_expandedItems.Contains(item.CommodityId) ? "بستن جزئیات" : "مشاهده جزئیات")</span>
                        <i class="bi @(_expandedItems.Contains(item.CommodityId) ? "bi-chevron-up" : "bi-chevron-down")"></i>
                    </div>
                </div>

                @* پنل جزئیات که به صورت شرطی نمایش داده می‌شود *@
                @if (_expandedItems.Contains(item.CommodityId))
                {
                    <div class="details-panel">
                        <div class="detail-item">
                            <span class="label">نرخ موفقیت</span>
                            <div class="progress-bar-container" title="@($"{item.SuccessRate:F0}%")">
                                <div class="progress-bar-fill" style="width: @(item.SuccessRate)%;"></div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <span class="label">میانگین رقابت</span>
                            <span class="value">@($"{item.AverageCompetition:F1}%")</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">وضعیت فروش</span>
                            <span class="value">@item.SellThroughStatus</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">مقایسه با رقبا</span>
                            <span class="value">
                                <span class="price-comparison-badge @GetPriceStatusClass(item.CompetitorPriceStatus)">
                                    @item.CompetitorPriceComparison
                                </span>
                            </span>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
}
else
{
    <div class="card">
        <div class="card-body">
            <p class="text-center mb-0">اطلاعاتی برای تحلیل وجود ندارد.</p>
        </div>
    </div>
}


@code {
    [Parameter]
    public SupplierCommodityAnalysisData? Data { get; set; }

    private HashSet<int> _expandedItems = new();

    private void ToggleDetails(int commodityId)
    {
        if (_expandedItems.Contains(commodityId))
        {
            _expandedItems.Remove(commodityId);
        }
        else
        {
            _expandedItems.Add(commodityId);
        }
    }

    private string GetPriceStatusClass(PriceComparisonStatus status) => status switch
    {
        PriceComparisonStatus.Higher => "status-higher",
        PriceComparisonStatus.Lower => "status-lower",
        PriceComparisonStatus.Similar => "status-similar",
        _ => "status-na"
    };
}